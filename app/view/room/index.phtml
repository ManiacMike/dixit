<?php include 'header.phtml';?>
<style>
.row{margin-bottom: 1rem;}
</style>
<div class="container">
  <h1><?=$this->room['name']?></h1>

  <div class="row">
    <div class="col-md-2">
      <p><?=$this->uid?></p>
    </div>
    <div class="col-md-2">
    <?php if($this->isJoined):?>
      <a type="button" id="quit-btn" data-id="<?=$this->room['id']?>" class="btn btn-danger">退出</a>
    <?php else:?>
      <a type="button" id="join-btn" data-id="<?=$this->room['id']?>" class="btn btn-info">加入</a>
    <?php endif;?>
    </div>
  </div>

  <p> 用户列表： </p>
  <div id="user_list">
    <div class="row">
      <div class="col-md-2">
      </div>
      <div class="col-md-2">
      </div>
    </div>
  </div>
</div>

<script>
var uid = "<?=$this->uid?>"
var ws = new WebSocket('ws://<?=$this->wsHost?>/?uid='+uid+'&room_id=<?=$this->room['id']?>');
var status = false;
var connected_ulist;
ws.onopen = function() {
  status = true
  //ws.send('{"event":"connect","room_id":"<?=$this->room['id']?>"}');
};
ws.onclose = function() {
  status = true
};
ws.onerror = function(e) {
  status = false
}
ws.onmessage = function(event) {
  var msg = JSON.parse(event.data);
  if(msg.type == "user_connect"){
    updateUserList(msg.user_list)
  }else if(msg.type == "user_disconnect"){
    updateUserList(msg.user_list)
  }
};
function updateUserList(ulist){
  ulist = ulist.split(",")
  connected_ulist = ulist
  var htmlStr = "<div class=\"row\">"
  for (var i = 0; i < ulist.length; i++) {
    htmlStr+="<div class=\"col-md-2\">"+ulist[i]+"</div>"
  }
  htmlStr+="</div>"
  $("#user_list").html(htmlStr)
}
</script>
<?php include 'footer.phtml';?>
